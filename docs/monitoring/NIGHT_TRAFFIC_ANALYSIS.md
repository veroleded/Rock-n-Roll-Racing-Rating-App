# Анализ ночного трафика

## Проблема

Сервер был заблокирован из-за отправки огромного количества пакетов в секунду (в 1000 раз больше обычного). Это указывает на проблему с количеством сетевых соединений/пакетов, а не только с объемом данных.

## Возможные причины

### 1. Discord бот - множественные переподключения
- Бот может переподключаться в цикле
- Каждое переподключение создает множество пакетов
- Проверьте логи на предмет `reconnect`, `Error`, `Ошибка`

### 2. Redis pub/sub - утечки подписок
- Множественные подписки на один канал
- Каждое событие отправляется всем подписчикам
- Проверьте количество активных подписок

### 3. HTTP запросы - DDoS или боты
- Множественные запросы с одного IP
- Автоматические скрипты/боты
- Проверьте логи Nginx на предмет подозрительных IP

### 4. WebSocket соединения
- Множественные WebSocket соединения
- Каждое соединение создает множество пакетов

## Анализ проблемы

### 1. Использование скрипта анализа

```bash
# Анализ вчерашней ночи
./scripts/analysis/analyze-night-traffic.sh

# Анализ конкретной даты
./scripts/analysis/analyze-night-traffic.sh 2025-12-29

# Анализ с указанием времени
./scripts/analysis/analyze-night-traffic.sh 2025-12-29 22:00 06:00
```

### 2. Проверка логов вручную

```bash
# Логи Discord бота за ночь
docker logs --since "2025-12-29T22:00" --until "2025-12-30T06:00" rnr_racing_app_bogdan | grep -i "reconnect\|error\|ошибка"

# Подсчет переподключений
docker logs --since "2025-12-29T22:00" --until "2025-12-30T06:00" rnr_racing_app_bogdan | grep -c "переподключ\|reconnect"

# Логи Nginx
docker logs --since "2025-12-29T22:00" --until "2025-12-30T06:00" rnr_racing_nginx_bogdan | tail -100

# Топ IP адресов
docker logs --since "2025-12-29T22:00" --until "2025-12-30T06:00" rnr_racing_nginx_bogdan | \
    grep -oE "\b([0-9]{1,3}\.){3}[0-9]{1,3}\b" | sort | uniq -c | sort -rn | head -20
```

### 3. Проверка Redis подписок

```bash
# Количество активных подписок
docker exec rnr_racing_redis_bogdan redis-cli PUBSUB NUMSUB

# Список всех каналов
docker exec rnr_racing_redis_bogdan redis-cli PUBSUB CHANNELS
```

### 4. Мониторинг пакетов в реальном времени

```bash
# Установка инструментов
sudo apt update && sudo apt install -y nethogs iftop

# Мониторинг пакетов по процессам
sudo nethogs

# Мониторинг трафика по соединениям
sudo iftop -i eth0
```

## Решения

### 1. Rate Limiting в Nginx (уже добавлено)

В `nginx.bogdan.conf` добавлен rate limiting:
- **Общие запросы**: 30 запросов/сек с burst до 50
- **API запросы**: 10 запросов/сек с burst до 20
- **Соединения**: максимум 20 соединений с одного IP, максимум 10 на location

### 2. Улучшение логирования Discord бота

Добавлено логирование всех переподключений и ошибок.

### 3. Защита от утечек Redis подписок

Уже реализована защита от дублирования подписок в `match-events.ts` и `queue-events.ts`.

### 4. Мониторинг количества пакетов

Используйте `nethogs` или `iftop` для мониторинга количества пакетов, а не только байт.

## Профилактика

1. **Регулярный мониторинг**: Запускайте `analyze-night-traffic.sh` каждое утро
2. **Алерты**: Настройте алерты при превышении пороговых значений
3. **Логирование**: Сохраняйте логи на диск для анализа
4. **Rate limiting**: Всегда используйте rate limiting в production

## Следующие шаги

1. Запустите анализ ночного трафика
2. Проверьте логи на предмет аномалий
3. Если проблема повторяется, увеличьте строгость rate limiting
4. Рассмотрите возможность использования Cloudflare или другого CDN для защиты

