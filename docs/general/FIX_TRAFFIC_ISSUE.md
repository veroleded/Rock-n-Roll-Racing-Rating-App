# Исправление проблемы с утечкой трафика (44 ГБ за 4 часа)

## Выявленные проблемы:

### 1. ⚠️ КРИТИЧНО: Уязвимость в Next.js 15.1.7
- **Текущая версия:** 15.1.7
- **Безопасная версия:** 15.1.9 (или выше)
- Хостинг провайдер указал, что эта уязвимость вызывает сильную нагрузку на сервер

### 2. ⚠️ КРИТИЧНО: Отсутствие защиты от множественных подписок в match-events.ts
- В `queue-events.ts` есть защита от дубликатов
- В `match-events.ts` НЕТ защиты - каждый вызов создает новую подписку
- При перезапуске бота могут накапливаться подписки

### 3. Отсутствие защиты от множественного запуска бота
- Если процесс бота перезапускается, может создаваться несколько экземпляров
- Каждый экземпляр создает свои подписки и соединения

### 4. Отсутствие ограничения на переподключения Discord
- При ошибках соединения бот может бесконечно пытаться переподключиться
- Каждая попытка генерирует трафик

## Примененные исправления:

### ✅ Исправление 1: Обновление Next.js
- Обновлено с 15.1.7 на 15.1.9 (безопасная версия)

### ✅ Исправление 2: Защита от множественного запуска
- Создан `src/bot/singleton.ts` - защита от дубликатов процесса
- Бот завершится с ошибкой, если попытается запуститься дважды

### ✅ Исправление 3: Ограничение переподключений Discord
- Добавлен счетчик попыток переподключения (максимум 5)
- После превышения лимита бот завершается, предотвращая утечку

### ✅ Исправление 4: Защита от множественных подписок в match-events
- Добавлена та же логика защиты, что и в queue-events
- Подписки создаются только один раз, callbacks добавляются в Set

## Что нужно сделать:

### 1. Обновить зависимости

```bash
npm install
```

Это обновит Next.js до 15.1.9

### 2. Пересобрать образ Docker

```bash
docker-compose -f docker-compose.prod.bogdan.yml build app
```

### 3. Перезапустить контейнеры

```bash
docker-compose -f docker-compose.prod.bogdan.yml down
docker-compose -f docker-compose.prod.bogdan.yml up -d
```

### 4. Мониторинг после запуска

```bash
# Проверка логов
docker-compose -f docker-compose.prod.bogdan.yml logs -f app

# Мониторинг ресурсов
docker stats rnr_racing_app_bogdan

# Проверка сетевой активности
watch -n 5 'docker exec rnr_racing_app_bogdan netstat -i 2>/dev/null || echo "Контейнер не запущен"'
```

### 5. Проверка наличия только одного процесса бота

В логах должно быть видно:
```
[Bot Singleton] Защита от множественного запуска активирована. ID: ...
[Redis Match] Подписан на события MATCH_CREATED
[Redis] Подписан на события QUEUE_CLEANED
```

Если видите несколько записей "[Bot Singleton]", значит что-то не так.

## Дополнительные рекомендации:

### Добавить мониторинг трафика

Используйте готовый скрипт:

```bash
# Непрерывный мониторинг
./scripts/monitoring/monitor-traffic-continuous.sh

# Или разовый просмотр
./scripts/monitoring/monitor-traffic.sh
```

### Настроить лимиты в Docker Compose

Добавьте в `docker-compose.prod.bogdan.yml` для сервиса `app`:

```yaml
deploy:
  resources:
    limits:
      memory: 2G
      cpus: '1.0'
    reservations:
      memory: 512M
      cpus: '0.5'
```

Это ограничит использование ресурсов контейнером.

## Ожидаемый результат:

После применения исправлений:
- ✅ Next.js обновлен до безопасной версии
- ✅ Защита от множественных процессов бота
- ✅ Ограничение переподключений Discord
- ✅ Защита от множественных Redis подписок
- ✅ Снижение трафика до нормального уровня

## Если проблема повторится:

1. Проверьте логи на наличие ошибок переподключения
2. Убедитесь, что бот запускается только один раз
3. Проверьте использование памяти и CPU
4. Проверьте сетевую активность в реальном времени
5. Свяжитесь с хостинг провайдером для детальной диагностики

