#!/bin/bash

# –°–†–û–ß–ù–ê–Ø –û–ß–ò–°–¢–ö–ê –î–ò–°–ö–ê - –î–∏—Å–∫ –∑–∞–ø–æ–ª–Ω–µ–Ω –Ω–∞ 98%!
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ –æ—á–∏—Å—Ç–∏—Ç Docker —Ä–µ—Å—É—Ä—Å—ã, –ù–ï —É–¥–∞–ª—è—è –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

set -e

echo "üö® –°–†–û–ß–ù–ê–Ø –û–ß–ò–°–¢–ö–ê –î–ò–°–ö–ê"
echo "========================"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
echo "üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏—Å–∫–∞:"
df -h / | tail -1
echo ""

echo "üìä –¢–µ–∫—É—â–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Docker:"
docker system df
echo ""

# –®–∞–≥ 1: –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (–±–µ–∑–æ–ø–∞—Å–Ω–æ)
echo "üßπ –®–∞–≥ 1: –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
if [ -d /var/lib/docker/containers ]; then
    # –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏ —á–µ—Ä–µ–∑ truncate (–±–µ–∑–æ–ø–∞—Å–Ω–µ–µ —á–µ–º —É–¥–∞–ª–µ–Ω–∏–µ)
    find /var/lib/docker/containers/ -name "*-json.log" -type f -exec truncate -s 0 {} \; 2>/dev/null || true
    echo "‚úÖ –õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã"
else
    echo "‚ö†Ô∏è  –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ª–æ–≥–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
fi
echo ""

# –®–∞–≥ 2: –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
echo "üõë –®–∞–≥ 2: –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
cd /root/Rock-n-Roll-Racing-Rating-App 2>/dev/null || cd /home/*/Rock-n-Roll-Racing-Rating-App 2>/dev/null || {
    echo "‚ö†Ô∏è  –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—Å—Ç–∞–Ω–æ–≤–∫—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"
    echo ""
}

if [ -f docker-compose.prod.yml ]; then
    echo "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
    docker-compose -f docker-compose.prod.yml down 2>/dev/null || true
    echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
else
    echo "‚ö†Ô∏è  docker-compose.prod.yml –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
fi
echo ""

# –®–∞–≥ 3: –£–¥–∞–ª–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
echo "üóëÔ∏è  –®–∞–≥ 3: –£–¥–∞–ª–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker container prune -f
echo ""

# –®–∞–≥ 4: –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –æ–±—Ä–∞–∑–æ–≤
echo "üñºÔ∏è  –®–∞–≥ 4: –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –æ–±—Ä–∞–∑–æ–≤..."
echo "‚ö†Ô∏è  –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è –∏ –æ—Å–≤–æ–±–æ–¥–∏—Ç –º–Ω–æ–≥–æ –º–µ—Å—Ç–∞..."
docker image prune -a -f
echo ""

# –®–∞–≥ 5: –û—á–∏—Å—Ç–∫–∞ build cache
echo "üóëÔ∏è  –®–∞–≥ 5: –û—á–∏—Å—Ç–∫–∞ build cache..."
docker builder prune -a -f
echo ""

# –®–∞–≥ 6: –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Å–µ—Ç–µ–π
echo "üåê –®–∞–≥ 6: –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Å–µ—Ç–µ–π..."
docker network prune -f
echo ""

# –®–∞–≥ 7: –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å–∏—Å—Ç–µ–º—ã Docker
echo "üßπ –®–∞–≥ 7: –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å–∏—Å—Ç–µ–º—ã Docker..."
docker system prune -a -f --volumes=false
echo ""

# –®–∞–≥ 8: –û—á–∏—Å—Ç–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ª–æ–≥–æ–≤
echo "üìù –®–∞–≥ 8: –û—á–∏—Å—Ç–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ª–æ–≥–æ–≤..."
journalctl --vacuum-time=3d 2>/dev/null || echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ª–æ–≥–∏"
echo ""

# –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "üìä –ù–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏—Å–∫–∞:"
df -h / | tail -1
echo ""

echo "üìä –ù–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Docker:"
docker system df
echo ""

echo "üíæ –†–∞–∑–º–µ—Ä overlay2 (–æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥):"
du -sh /var/lib/docker/overlay2 2>/dev/null || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å"
echo ""

# –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ volumes
echo "‚ö†Ô∏è  –í–ê–ñ–ù–û: Volumes –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ù–ï –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã!"
echo "   –ó–∞—â–∏—â–µ–Ω–Ω—ã–µ volumes: postgres_data, next_build_cache"
echo ""

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ
if [ -f docker-compose.prod.yml ]; then
    echo "üîÑ –î–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
    echo "   docker-compose -f docker-compose.prod.yml up -d --build"
fi
