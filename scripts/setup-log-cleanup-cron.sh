#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ –ª–æ–≥–æ–≤ —á–µ—Ä–µ–∑ cron
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: sudo ./setup-log-cleanup-cron.sh

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

echo "=========================================="
echo "  –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ –ª–æ–≥–æ–≤"
echo "=========================================="
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤
if [ "$EUID" -ne 0 ]; then 
    echo "‚ö†Ô∏è  –í–Ω–∏–º–∞–Ω–∏–µ: –î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ cron —Ç—Ä–µ–±—É–µ—Ç—Å—è sudo"
    echo "   –ó–∞–ø—É—Å—Ç–∏—Ç–µ: sudo $0"
    echo ""
    echo "–ò–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ crontab –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:"
    echo "  crontab -e"
    echo ""
    echo "–î–æ–±–∞–≤—å—Ç–µ —Å—Ç—Ä–æ–∫–∏:"
    echo "  # –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤ –º–µ—Ç—Ä–∏–∫ (–∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 2:00)"
    echo "  0 2 * * * cd $PROJECT_ROOT && bash scripts/cleanup/cleanup-metrics-logs.sh 30 >> logs/cleanup.log 2>&1"
    echo ""
    echo "  # –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –ª–æ–≥–æ–≤ (–∫–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é –≤ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 3:00)"
    echo "  0 3 * * 0 cd $PROJECT_ROOT && bash scripts/cleanup/cleanup-all-logs.sh >> logs/cleanup.log 2>&1"
    exit 0
fi

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è cron (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)
APP_USER=${1:-$SUDO_USER}

if [ -z "$APP_USER" ]; then
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
    echo "   –£–∫–∞–∂–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: sudo $0 <username>"
    exit 1
fi

echo "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: $APP_USER"
echo "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞: $PROJECT_ROOT"
echo ""

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤ –æ—á–∏—Å—Ç–∫–∏
mkdir -p "$PROJECT_ROOT/logs"
chown "$APP_USER:$APP_USER" "$PROJECT_ROOT/logs" 2>/dev/null || true

# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å cron –∑–∞–¥–∞—á–∞–º–∏
CRON_TEMP=$(mktemp)

# –ü–æ–ª—É—á–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ cron –∑–∞–¥–∞—á–∏
crontab -u "$APP_USER" -l 2>/dev/null > "$CRON_TEMP" || true

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –ª–∏ —É–∂–µ –∑–∞–¥–∞—á–∏
if grep -q "cleanup/cleanup-metrics-logs.sh\|cleanup-metrics-logs.sh" "$CRON_TEMP" 2>/dev/null; then
    echo "‚ÑπÔ∏è  –ó–∞–¥–∞—á–∏ –æ—á–∏—Å—Ç–∫–∏ —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"
    echo ""
    echo "–¢–µ–∫—É—â–∏–µ –∑–∞–¥–∞—á–∏:"
    grep "cleanup.*logs" "$CRON_TEMP" || echo "  –ù–µ –Ω–∞–π–¥–µ–Ω–æ"
else
    # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á–∏ –æ—á–∏—Å—Ç–∫–∏
    echo "" >> "$CRON_TEMP"
    echo "# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è" >> "$CRON_TEMP"
    echo "# –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤ –º–µ—Ç—Ä–∏–∫ (–∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 2:00, —Ö—Ä–∞–Ω–∏—Ç—å 30 –¥–Ω–µ–π)" >> "$CRON_TEMP"
    echo "0 2 * * * cd $PROJECT_ROOT && bash scripts/cleanup/cleanup-metrics-logs.sh 30 >> logs/cleanup.log 2>&1" >> "$CRON_TEMP"
    echo "" >> "$CRON_TEMP"
    echo "# –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –ª–æ–≥–æ–≤ (–∫–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é –≤ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 3:00)" >> "$CRON_TEMP"
    echo "0 3 * * 0 cd $PROJECT_ROOT && bash scripts/cleanup/cleanup-all-logs.sh >> logs/cleanup.log 2>&1" >> "$CRON_TEMP"
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–µ cron –∑–∞–¥–∞—á–∏
    crontab -u "$APP_USER" "$CRON_TEMP"
    
    echo "‚úÖ –ó–∞–¥–∞—á–∏ –æ—á–∏—Å—Ç–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ cron"
    echo ""
    echo "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:"
    echo "  - –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤ –º–µ—Ç—Ä–∏–∫: –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 2:00 (—Ö—Ä–∞–Ω–∏—Ç—å 30 –¥–Ω–µ–π)"
    echo "  - –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –ª–æ–≥–æ–≤: –∫–∞–∂–¥–æ–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 3:00"
    echo ""
    echo "–õ–æ–≥–∏ –æ—á–∏—Å—Ç–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤: $PROJECT_ROOT/logs/cleanup.log"
fi

# –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
rm -f "$CRON_TEMP"

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∑–∞–¥–∞—á–∏
echo "=========================================="
echo "  –¢–µ–∫—É—â–∏–µ cron –∑–∞–¥–∞—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è $APP_USER"
echo "=========================================="
crontab -u "$APP_USER" -l 2>/dev/null | grep -E "(cleanup|CLEANUP)" || echo "  –ù–µ –Ω–∞–π–¥–µ–Ω–æ –∑–∞–¥–∞—á –æ—á–∏—Å—Ç–∫–∏"
echo ""

echo "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
echo ""
echo "üí° –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "   –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–¥–∞—á: crontab -u $APP_USER -l"
echo "   –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: crontab -u $APP_USER -e"
echo "   –õ–æ–≥–∏ –æ—á–∏—Å—Ç–∫–∏: tail -f $PROJECT_ROOT/logs/cleanup.log"
echo "=========================================="

