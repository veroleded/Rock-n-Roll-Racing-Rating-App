#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ systemd timer –∏–ª–∏ cron
#
# –í–ê–ñ–ù–û: –ü–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –æ–±–Ω–æ–≤–∏—Ç–µ PROJECT_DIR –Ω–∞ –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π –ø—É—Ç—å!

# ============================================
# –ù–ê–°–¢–†–û–ô–ö–ò - –ò–ó–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–®–ò –ó–ù–ê–ß–ï–ù–ò–Ø
# ============================================
PROJECT_DIR="/root/Rock-n-Roll-Racing-Rating-App"
COMPOSE_FILE="docker-compose.prod.bogdan.yml"

# ============================================
# –ü–†–û–í–ï–†–ö–ò
# ============================================

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if [ ! -d "$PROJECT_DIR" ]; then
    echo "‚ùå –û–®–ò–ë–ö–ê: –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: $PROJECT_DIR"
    echo "   –û–±–Ω–æ–≤–∏—Ç–µ PROJECT_DIR –≤ —Å–∫—Ä–∏–ø—Ç–µ renew-ssl.sh"
    exit 1
fi

# –ü–µ—Ä–µ–π—Ç–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd "$PROJECT_DIR" || exit 1

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ docker compose
if ! command -v docker &> /dev/null; then
    echo "‚ùå –û–®–ò–ë–ö–ê: Docker –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–ª–∏ –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ certbot
if ! command -v certbot &> /dev/null; then
    echo "‚ùå –û–®–ò–ë–ö–ê: Certbot –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    exit 1
fi

# ============================================
# –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ï–†–¢–ò–§–ò–ö–ê–¢–ê
# ============================================

echo "========================================="
echo "üîÑ –ù–∞—á–∞–ª–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞"
echo "–í—Ä–µ–º—è: $(date)"
echo "========================================="

# –û–±–Ω–æ–≤–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
# --quiet: —Ç–∏—Ö–∏–π —Ä–µ–∂–∏–º (—Ç–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏)
# --no-random-sleep-on-renew: –Ω–µ –∂–¥–∞—Ç—å —Å–ª—É—á–∞–π–Ω–æ–µ –≤—Ä–µ–º—è (–¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏)
if certbot renew --quiet --no-random-sleep-on-renew; then
    echo "‚úÖ Certbot –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ"
    
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –±—ã–ª –ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
    # Certbot –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è < 30 –¥–Ω–µ–π
    CERT_INFO=$(sudo certbot certificates 2>/dev/null | grep -A 5 "rocknrollracing.online")
    
    # –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å nginx –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
    echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ nginx –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
    
    # –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å docker compose (–Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è)
    if docker compose version &> /dev/null; then
        docker compose -f "$COMPOSE_FILE" restart nginx
    # –ò–Ω–∞—á–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å docker-compose (—Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è)
    elif command -v docker-compose &> /dev/null; then
        docker-compose -f "$COMPOSE_FILE" restart nginx
    else
        echo "‚ùå –û–®–ò–ë–ö–ê: docker compose –∏–ª–∏ docker-compose –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
        exit 1
    fi
    
    if [ $? -eq 0 ]; then
        echo "‚úÖ Nginx —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
        echo "‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ"
        echo ""
        echo "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–µ:"
        sudo certbot certificates 2>/dev/null | grep -A 10 "rocknrollracing.online" || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é"
    else
        echo "‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å nginx"
        echo "   –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é: docker compose -f $COMPOSE_FILE restart nginx"
        exit 1
    fi
else
    EXIT_CODE=$?
    echo "‚ö†Ô∏è  Certbot –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –∫–æ–¥–æ–º: $EXIT_CODE"
    
    # –ö–æ–¥ 0 –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è (—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –µ—â–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω)
    if [ $EXIT_CODE -eq 0 ]; then
        echo "‚ÑπÔ∏è  –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–µ—â–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –±–æ–ª–µ–µ 30 –¥–Ω–µ–π)"
    else
        echo "‚ùå –û–®–ò–ë–ö–ê –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞"
        echo ""
        echo "üìã –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞:"
        sudo certbot certificates 2>/dev/null | grep -A 10 "rocknrollracing.online" || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é"
        exit 1
    fi
fi

echo ""
echo "–í—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: $(date)"
echo "========================================="
echo ""

