#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —É—Ç–∏–ª–∏—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ç—Ä–∞—Ñ–∏–∫–∞ –Ω–∞ VPS
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: sudo ./install-vps-traffic-tools.sh

set -e

echo "=========================================="
echo "  –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —É—Ç–∏–ª–∏—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ç—Ä–∞—Ñ–∏–∫–∞"
echo "=========================================="
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤
if [ "$EUID" -ne 0 ]; then 
    echo "‚ùå –û—à–∏–±–∫–∞: –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å sudo"
    exit 1
fi

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤
if [ -f /etc/debian_version ]; then
    DISTRO="debian"
    echo "üì¶ –û–±–Ω–∞—Ä—É–∂–µ–Ω Debian/Ubuntu"
elif [ -f /etc/redhat-release ]; then
    DISTRO="rhel"
    echo "üì¶ –û–±–Ω–∞—Ä—É–∂–µ–Ω RHEL/CentOS"
else
    echo "‚ùå –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤"
    exit 1
fi

echo ""
echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤..."

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤
if [ "$DISTRO" = "debian" ]; then
    apt update
    apt install -y vnstat vnstati iftop nethogs nload bmon jq bc
elif [ "$DISTRO" = "rhel" ]; then
    yum install -y epel-release
    yum install -y vnstat vnstati iftop nethogs nload bmon jq bc
fi

echo ""
echo "‚úÖ –ü–∞–∫–µ—Ç—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
echo ""

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–µ—Ç–µ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
INTERFACE=$(ip route | grep default | awk '{print $5}' | head -1)

if [ -z "$INTERFACE" ]; then
    echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–µ—Ç–µ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å"
    echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã:"
    ip link show | grep -E "^[0-9]+:" | awk '{print $2}' | sed 's/://'
    echo ""
    read -p "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, eth0): " INTERFACE
fi

if [ -z "$INTERFACE" ]; then
    echo "‚ùå –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–µ —É–∫–∞–∑–∞–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é vnstat"
else
    echo "üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è vnstat –¥–ª—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞: $INTERFACE"
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è vnstat
    vnstat -i "$INTERFACE" 2>/dev/null || true
    
    # –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
    systemctl enable vnstat
    systemctl start vnstat
    
    echo "‚úÖ vnstat –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∏ –∑–∞–ø—É—â–µ–Ω"
fi

echo ""
echo "=========================================="
echo "  –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo "=========================================="
echo ""
echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo ""
echo "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç—Ä–∞—Ñ–∏–∫–∞:"
echo "   vnstat              - —Ç–µ–∫—É—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"
echo "   vnstat -d           - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –¥–µ–Ω—å"
echo "   vnstat -m           - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –º–µ—Å—è—Ü"
echo ""
echo "üì° –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏:"
echo "   sudo iftop -i $INTERFACE    - —Ç—Ä–∞—Ñ–∏–∫ –ø–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º"
echo "   sudo nethogs                - —Ç—Ä–∞—Ñ–∏–∫ –ø–æ –ø—Ä–æ—Ü–µ—Å—Å–∞–º"
echo "   nload                      - –ø—Ä–æ—Å—Ç–æ–π –º–æ–Ω–∏—Ç–æ—Ä"
echo ""
echo "üîç –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:"
echo "   watch -n 2 vnstat          - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫"
echo "   vnstat --json             - —ç–∫—Å–ø–æ—Ä—Ç –≤ JSON"
echo ""
echo "=========================================="

