#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –≤—Å–µ—Ö –ª–æ–≥–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./cleanup-all-logs.sh
# –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ cron —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
cd "$PROJECT_ROOT"

echo "=========================================="
echo "  –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –ª–æ–≥–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
echo "=========================================="
echo "–í—Ä–µ–º—è: $(date '+%Y-%m-%d %H:%M:%S')"
echo "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞: $PROJECT_ROOT"
echo ""

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
get_dir_size() {
    du -sh "$1" 2>/dev/null | cut -f1 || echo "0"
}

# 1. –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤ –º–µ—Ç—Ä–∏–∫ (—Ö—Ä–∞–Ω–∏–º 30 –¥–Ω–µ–π)
echo "1. –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤ –º–µ—Ç—Ä–∏–∫..."
echo "-----------------------------------"
if [ -f "scripts/cleanup/cleanup-metrics-logs.sh" ]; then
    bash "scripts/cleanup/cleanup-metrics-logs.sh" 30
else
    echo "‚ö†Ô∏è  –°–∫—Ä–∏–ø—Ç –æ—á–∏—Å—Ç–∫–∏ –º–µ—Ç—Ä–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi
echo ""

# 2. –û—á–∏—Å—Ç–∫–∞ Docker –ª–æ–≥–æ–≤ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
echo "2. –û—á–∏—Å—Ç–∫–∞ Docker –ª–æ–≥–æ–≤..."
echo "-----------------------------------"
if command -v docker &> /dev/null; then
    # –†–∞–∑–º–µ—Ä –ª–æ–≥–æ–≤ –¥–æ –æ—á–∏—Å—Ç–∫–∏
    DOCKER_SIZE_BEFORE=$(docker system df 2>/dev/null | grep "Local Volumes" | awk '{print $3}' || echo "0")
    echo "   –†–∞–∑–º–µ—Ä Docker –¥–∞–Ω–Ω—ã—Ö –¥–æ –æ—á–∏—Å—Ç–∫–∏: $DOCKER_SIZE_BEFORE"
    
    # –û—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ!)
    # docker system prune -f --volumes 2>/dev/null || true
    
    # –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100MB)
    if [ -d "/var/lib/docker/containers" ]; then
        echo "   –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
        find /var/lib/docker/containers -name "*-json.log" -type f -exec truncate -s 10M {} \; 2>/dev/null || true
    fi
    
    echo "   ‚úÖ Docker –ª–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã"
else
    echo "   ‚ÑπÔ∏è  Docker –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è"
fi
echo ""

# 3. –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo "3. –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
echo "-----------------------------------"
LOGS_DIR="logs"

if [ -d "$LOGS_DIR" ]; then
    SIZE_BEFORE=$(get_dir_size "$LOGS_DIR")
    echo "   –†–∞–∑–º–µ—Ä –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ª–æ–≥–æ–≤: $SIZE_BEFORE"
    
    # –£–¥–∞–ª—è–µ–º –ª–æ–≥–∏ —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π (–∫—Ä–æ–º–µ –º–µ—Ç—Ä–∏–∫, –∫–æ—Ç–æ—Ä—ã–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ)
    find "$LOGS_DIR" -type f -name "*.log" -mtime +30 -delete 2>/dev/null || true
    find "$LOGS_DIR" -type f -name "*.log.*" -mtime +30 -delete 2>/dev/null || true
    
    # –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    find "$LOGS_DIR" -type d -empty -delete 2>/dev/null || true
    
    SIZE_AFTER=$(get_dir_size "$LOGS_DIR")
    echo "   –†–∞–∑–º–µ—Ä –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏: $SIZE_AFTER"
    echo "   ‚úÖ –õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –æ—á–∏—â–µ–Ω—ã"
else
    echo "   ‚ÑπÔ∏è  –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ª–æ–≥–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
fi
echo ""

# 4. –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ Next.js
echo "4. –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ Next.js..."
echo "-----------------------------------"
if [ -d ".next" ]; then
    NEXT_SIZE_BEFORE=$(get_dir_size ".next")
    echo "   –†–∞–∑–º–µ—Ä .next –¥–æ –æ—á–∏—Å—Ç–∫–∏: $NEXT_SIZE_BEFORE"
    
    # –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ —Å–±–æ—Ä–∫–∏ (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ - –º–æ–∂–µ—Ç –∑–∞–º–µ–¥–ª–∏—Ç—å —Å–ª–µ–¥—É—é—â—É—é —Å–±–æ—Ä–∫—É)
    # find .next/cache -type f -mtime +7 -delete 2>/dev/null || true
    
    echo "   ‚ÑπÔ∏è  –ö—ç—à Next.js —Å–æ—Ö—Ä–∞–Ω–µ–Ω (–º–æ–∂–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)"
else
    echo "   ‚ÑπÔ∏è  –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è .next –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
fi
echo ""

# 5. –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
echo "5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
echo "-----------------------------------"
if [ -d "uploads" ]; then
    UPLOADS_SIZE=$(get_dir_size "uploads")
    UPLOADS_COUNT=$(find uploads -type f 2>/dev/null | wc -l | tr -d ' ')
    echo "   –†–∞–∑–º–µ—Ä uploads: $UPLOADS_SIZE"
    echo "   –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤: $UPLOADS_COUNT"
    echo "   ‚ÑπÔ∏è  –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"
else
    echo "   ‚ÑπÔ∏è  –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è uploads –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
fi
echo ""

# 6. –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
echo "=========================================="
echo "  –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"
echo "=========================================="

# –û–±—â–∏–π —Ä–∞–∑–º–µ—Ä –ª–æ–≥–æ–≤
if [ -d "$LOGS_DIR" ]; then
    TOTAL_LOGS_SIZE=$(get_dir_size "$LOGS_DIR")
    echo "üìä –û–±—â–∏–π —Ä–∞–∑–º–µ—Ä –ª–æ–≥–æ–≤: $TOTAL_LOGS_SIZE"
fi

# –†–∞–∑–º–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞ (–±–µ–∑ node_modules)
if command -v du &> /dev/null; then
    PROJECT_SIZE=$(du -sh --exclude=node_modules --exclude=.next . 2>/dev/null | cut -f1 || echo "N/A")
    echo "üì¶ –†–∞–∑–º–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞: $PROJECT_SIZE"
fi

echo ""
echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
echo "=========================================="

