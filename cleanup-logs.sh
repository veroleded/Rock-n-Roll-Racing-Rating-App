#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –ª–æ–≥–æ–≤ –∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ systemd timer –∏–ª–∏ cron

echo "========================================="
echo "üßπ –ù–∞—á–∞–ª–æ –æ—á–∏—Å—Ç–∫–∏ –ª–æ–≥–æ–≤ –∏ Docker –¥–∞–Ω–Ω—ã—Ö"
echo "–í—Ä–µ–º—è: $(date)"
echo "========================================="

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–∏—Å–∫–∞ –¥–æ –æ—á–∏—Å—Ç–∫–∏
echo ""
echo "üìä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞ –î–û –æ—á–∏—Å—Ç–∫–∏:"
df -h / | tail -1

# 1. –û—á–∏—Å—Ç–∫–∞ Docker –ª–æ–≥–æ–≤
echo ""
echo "üê≥ –û—á–∏—Å—Ç–∫–∞ Docker –ª–æ–≥–æ–≤..."
if command -v docker &> /dev/null; then
    # –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100MB)
    docker system prune -f --volumes 2>/dev/null || true
    
    # –û—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –æ–±—Ä–∞–∑–æ–≤
    docker image prune -af --filter "until=168h" 2>/dev/null || true
    
    # –û—á–∏—Å—Ç–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π
    docker container prune -f --filter "until=168h" 2>/dev/null || true
    
    echo "‚úÖ Docker –æ—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
else
    echo "‚ö†Ô∏è  Docker –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
fi

# 2. –û—á–∏—Å—Ç–∫–∞ systemd journal –ª–æ–≥–æ–≤
echo ""
echo "üìã –û—á–∏—Å—Ç–∫–∞ systemd journal –ª–æ–≥–æ–≤..."
if command -v journalctl &> /dev/null; then
    # –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100MB –ª–æ–≥–æ–≤
    journalctl --vacuum-size=100M 2>/dev/null || true
    echo "‚úÖ Journal –ª–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã"
else
    echo "‚ö†Ô∏è  journalctl –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
fi

# 3. –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤ –≤ /var/log
echo ""
echo "üìÅ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤ –≤ /var/log..."
if [ -d "/var/log" ]; then
    # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤ (—Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π)
    find /var/log -type f -name "*.log" -mtime +30 -delete 2>/dev/null || true
    find /var/log -type f -name "*.gz" -mtime +30 -delete 2>/dev/null || true
    echo "‚úÖ –°—Ç–∞—Ä—ã–µ –ª–æ–≥–∏ –≤ /var/log –æ—á–∏—â–µ–Ω—ã"
else
    echo "‚ö†Ô∏è  /var/log –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
fi

# 4. –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
echo ""
echo "üóëÔ∏è  –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
if [ -d "/tmp" ]; then
    find /tmp -type f -atime +7 -delete 2>/dev/null || true
    echo "‚úÖ –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –æ—á–∏—â–µ–Ω—ã"
fi

# 5. –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö Docker volumes (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ!)
# –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—á–∏—â–∞—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ volumes
# echo ""
# echo "üíæ –û—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö Docker volumes..."
# docker volume prune -f 2>/dev/null || true

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–∏—Å–∫–∞ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏
echo ""
echo "üìä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞ –ü–û–°–õ–ï –æ—á–∏—Å—Ç–∫–∏:"
df -h / | tail -1

echo ""
echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
echo "–í—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: $(date)"
echo "========================================="
echo ""

