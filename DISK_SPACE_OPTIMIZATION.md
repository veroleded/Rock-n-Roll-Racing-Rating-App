# Оптимизация использования дискового пространства

Этот документ описывает изменения, внесенные для решения проблемы нехватки места на диске на продакшн сервере.

## Проблемы, которые были решены

### 1. ✅ Ограничение размера Docker логов
**Проблема:** Docker логи накапливались без ограничений, занимая много места.

**Решение:** Добавлены ограничения на размер логов для всех сервисов в `docker-compose.prod.yml`:
- Максимальный размер одного лог-файла: 10MB
- Максимальное количество лог-файлов: 3
- Общий максимум логов на сервис: ~30MB

### 2. ✅ Оптимизация Dockerfile
**Проблема:** Docker образ был большим из-за отсутствия оптимизации.

**Решение:** 
- Использован multi-stage build для уменьшения размера финального образа
- Добавлена очистка npm кэша после установки зависимостей
- Оптимизирована структура копирования файлов

### 3. ✅ Кэширование сборки Next.js
**Проблема:** При каждом перезапуске контейнера выполнялась полная пересборка Next.js, что занимало время и место.

**Решение:**
- Добавлен named volume `next_build_cache` для кэширования папки `.next`
- Сборка выполняется только если кэш отсутствует
- Это значительно ускоряет перезапуск и экономит место

### 4. ✅ Скрипты для очистки Docker ресурсов
**Проблема:** Старые Docker образы, контейнеры и volumes накапливались на сервере.

**Решение:** Создан скрипт `cleanup-docker.sh` для очистки:
- Остановленных контейнеров
- Неиспользуемых образов
- Неиспользуемых volumes
- Build cache

### 5. ✅ Скрипт для очистки старых данных из базы
**Проблема:** База данных могла расти бесконечно из-за накопления старых матчей, очередей и сессий.

**Решение:** Создан скрипт `prisma/cleanup-old-data.ts` для очистки:
- Матчей старше 90 дней (настраивается)
- Завершенных очередей старше 30 дней (настраивается)
- Истекших сессий
- Истекших токенов верификации

## Использование

### Проверка использования диска
```bash
./check-disk-usage.sh
```

### Очистка Docker ресурсов
```bash
# Безопасная очистка (volumes НЕ удаляются)
./cleanup-docker.sh

# С очисткой volumes (осторожно! Убедитесь, что важные volumes защищены)
./cleanup-docker.sh --with-volumes
```

**⚠️ ВАЖНО:** По умолчанию скрипт НЕ удаляет volumes для защиты данных базы данных. Volumes `postgres_data` и `next_build_cache` всегда защищены от удаления.

### Очистка старых данных из базы (режим просмотра)
```bash
npm run cleanup-old-data -- --dry-run
```

### Очистка старых данных из базы (реальное удаление)
```bash
npm run cleanup-old-data
```

### Очистка с настройкой параметров
```bash
# Удалить матчи старше 60 дней и очереди старше 14 дней
npm run cleanup-old-data -- --matches-days=60 --queues-days=14
```

## Рекомендации по обслуживанию

### Еженедельно
1. Запускать `./cleanup-docker.sh` для очистки неиспользуемых Docker ресурсов (volumes не удаляются)
2. Проверять использование диска с помощью `./check-disk-usage.sh`

### Ежемесячно
1. Запускать `npm run cleanup-old-data` для очистки старых данных из базы
2. Проверять размер PostgreSQL volume: `docker volume inspect <volume_name>`

### При нехватке места
1. Запустить `./check-disk-usage.sh` для диагностики
2. Запустить `./cleanup-docker.sh` для очистки Docker
3. Запустить `npm run cleanup-old-data -- --dry-run` для проверки данных к удалению
4. При необходимости запустить реальную очистку данных

## Мониторинг

Для автоматического мониторинга можно добавить cron задачи:

```bash
# Очистка Docker ресурсов каждую неделю (воскресенье в 3:00)
0 3 * * 0 /path/to/project/cleanup-docker.sh

# Очистка старых данных каждый месяц (1-го числа в 4:00)
0 4 1 * * cd /path/to/project && npm run cleanup-old-data
```

## Дополнительные оптимизации (опционально)

### Настройка PostgreSQL
Можно добавить автоматический VACUUM и настройки для уменьшения размера базы:
```sql
-- В psql внутри контейнера
VACUUM FULL;
```

### Настройка ротации логов на уровне системы
Можно настроить logrotate для системных логов:
```bash
# /etc/logrotate.d/docker-containers
/var/lib/docker/containers/*/*.log {
  rotate 7
  daily
  compress
  size=10M
  missingok
  delaycompress
  copytruncate
}
```

## Важные замечания

⚠️ **ВНИМАНИЕ:** Скрипт `cleanup-old-data.ts` удаляет данные безвозвратно! Всегда делайте резервную копию базы данных перед запуском реальной очистки.

⚠️ Скрипт `cleanup-docker.sh` по умолчанию **НЕ удаляет volumes** для защиты данных базы. Volumes `postgres_data` и `next_build_cache` всегда защищены от удаления, даже при использовании флага `--with-volumes`.

